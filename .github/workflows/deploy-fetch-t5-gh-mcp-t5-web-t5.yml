# AUTO-GENERATED by multi-app-setup-secrets.sh
# Generated on 2026-02-18
# App 1: fetch-t5 (secrets prefix: FETCH_T5_*)
# App 2: gh-mcp-t5 (secrets prefix: GH_MCP_T5_*)
# App 3: web-t5 (secrets prefix: WEB_T5_*)
#
name: Deploy fetch-t5 & gh-mcp-t5 & web-t5 to Cloud Foundry

# On-demand only — manually triggered from the Actions tab
on:
  workflow_dispatch:
    inputs:
      fetch_t5_release_tag:
        description: 'fetch-t5 release tag (e.g., v2.7.0)'
        required: false
        type: string
      gh_mcp_t5_release_tag:
        description: 'gh-mcp-t5 release tag (e.g., v2.7.0)'
        required: false
        type: string
      web_t5_release_tag:
        description: 'web-t5 release tag (e.g., v2.7.0)'
        required: false
        type: string
      deploy_fetch_t5:
        description: 'Deploy fetch-t5'
        required: false
        type: boolean
        default: true
      deploy_gh_mcp_t5:
        description: 'Deploy gh-mcp-t5'
        required: false
        type: boolean
        default: true
      deploy_web_t5:
        description: 'Deploy web-t5'
        required: false
        type: boolean
        default: true

permissions:
  contents: write
  actions: read
  deployments: write

env:
  CF_CLI_VERSION: "v8"

jobs:
  # ──────────────────────────────────────────────────────────────
  # Job 1: Validate releases and prepare artifacts
  # ──────────────────────────────────────────────────────────────
  validate-and-prepare:
    runs-on: ubuntu-latest
    outputs:
      fetch_t5_release_tag: ${{ steps.validate.outputs.fetch_t5_release_tag }}
      fetch_t5_version: ${{ steps.validate.outputs.fetch_t5_version }}
      fetch_t5_version_dotted: ${{ steps.validate.outputs.fetch_t5_version_dotted }}
      gh_mcp_t5_release_tag: ${{ steps.validate.outputs.gh_mcp_t5_release_tag }}
      gh_mcp_t5_version: ${{ steps.validate.outputs.gh_mcp_t5_version }}
      gh_mcp_t5_version_dotted: ${{ steps.validate.outputs.gh_mcp_t5_version_dotted }}
      web_t5_release_tag: ${{ steps.validate.outputs.web_t5_release_tag }}
      web_t5_version: ${{ steps.validate.outputs.web_t5_version }}
      web_t5_version_dotted: ${{ steps.validate.outputs.web_t5_version_dotted }}
      deploy_fetch_t5: ${{ steps.validate.outputs.deploy_fetch_t5 }}
      deploy_gh_mcp_t5: ${{ steps.validate.outputs.deploy_gh_mcp_t5 }}
      deploy_web_t5: ${{ steps.validate.outputs.deploy_web_t5 }}
    steps:
      - uses: actions/checkout@v4

      - name: Configure GitHub Authentication
        env:
          GHE_TOKEN: ${{ secrets.GHE_TOKEN }}
          GHE_HOST: ${{ secrets.GHE_HOST }}
        run: |
          if [ -z "$GHE_TOKEN" ]; then
            echo "Error: GHE_TOKEN secret must be configured"
            exit 1
          fi

          if [ -n "$GHE_HOST" ]; then
            echo "${GHE_TOKEN}" | gh auth login --hostname "${GHE_HOST}" --with-token
            gh auth status --hostname "${GHE_HOST}"
            echo "Authenticated to GitHub Enterprise: ${GHE_HOST}"
          else
            echo "${GHE_TOKEN}" | gh auth login --with-token
            gh auth status
            echo "Authenticated to github.com"
          fi

      - name: Show configuration summary
        env:
          FETCH_T5_NAME: ${{ secrets.FETCH_T5_NAME }}
          FETCH_T5_UPSTREAM_REPO: ${{ secrets.FETCH_T5_UPSTREAM_REPO }}
          GH_MCP_T5_NAME: ${{ secrets.GH_MCP_T5_NAME }}
          GH_MCP_T5_UPSTREAM_REPO: ${{ secrets.GH_MCP_T5_UPSTREAM_REPO }}
          WEB_T5_NAME: ${{ secrets.WEB_T5_NAME }}
          WEB_T5_UPSTREAM_REPO: ${{ secrets.WEB_T5_UPSTREAM_REPO }}
        run: |
          echo "=========================================="
          echo "DEPLOYMENT CONFIGURATION"
          echo "=========================================="
          echo "fetch-t5 (fetch_t5_release_tag):  ${FETCH_T5_NAME}"
          echo "  Upstream repo:           ${FETCH_T5_UPSTREAM_REPO}"
          echo "  Deploy:                  ${{ inputs.deploy_fetch_t5 }}"
          echo "  Release tag:             ${{ inputs.fetch_t5_release_tag }}"
          echo "------------------------------------------"
          echo "gh-mcp-t5 (gh_mcp_t5_release_tag):  ${GH_MCP_T5_NAME}"
          echo "  Upstream repo:           ${GH_MCP_T5_UPSTREAM_REPO}"
          echo "  Deploy:                  ${{ inputs.deploy_gh_mcp_t5 }}"
          echo "  Release tag:             ${{ inputs.gh_mcp_t5_release_tag }}"
          echo "------------------------------------------"
          echo "web-t5 (web_t5_release_tag):  ${WEB_T5_NAME}"
          echo "  Upstream repo:           ${WEB_T5_UPSTREAM_REPO}"
          echo "  Deploy:                  ${{ inputs.deploy_web_t5 }}"
          echo "  Release tag:             ${{ inputs.web_t5_release_tag }}"
          echo "=========================================="

      - name: Validate inputs
        run: |
          DEPLOY_FETCH_T5="${{ inputs.deploy_fetch_t5 }}"
          FETCH_T5_TAG="${{ inputs.fetch_t5_release_tag }}"
          DEPLOY_GH_MCP_T5="${{ inputs.deploy_gh_mcp_t5 }}"
          GH_MCP_T5_TAG="${{ inputs.gh_mcp_t5_release_tag }}"
          DEPLOY_WEB_T5="${{ inputs.deploy_web_t5 }}"
          WEB_T5_TAG="${{ inputs.web_t5_release_tag }}"

          if [ "$DEPLOY_FETCH_T5" = "true" ] && [ -z "$FETCH_T5_TAG" ]; then
            echo "Error: fetch_t5_release_tag is required when deploy_fetch_t5 is enabled"
            exit 1
          fi
          if [ "$DEPLOY_GH_MCP_T5" = "true" ] && [ -z "$GH_MCP_T5_TAG" ]; then
            echo "Error: gh_mcp_t5_release_tag is required when deploy_gh_mcp_t5 is enabled"
            exit 1
          fi
          if [ "$DEPLOY_WEB_T5" = "true" ] && [ -z "$WEB_T5_TAG" ]; then
            echo "Error: web_t5_release_tag is required when deploy_web_t5 is enabled"
            exit 1
          fi
      - name: Validate releases
        id: validate
        env:
          _GHE_HOST: ${{ secrets.GHE_HOST }}
          GH_TOKEN: ${{ secrets.GHE_TOKEN }}
          FETCH_T5_UPSTREAM_REPO: ${{ secrets.FETCH_T5_UPSTREAM_REPO }}
          GH_MCP_T5_UPSTREAM_REPO: ${{ secrets.GH_MCP_T5_UPSTREAM_REPO }}
          WEB_T5_UPSTREAM_REPO: ${{ secrets.WEB_T5_UPSTREAM_REPO }}
        run: |
          [ -n "$_GHE_HOST" ] && export GH_HOST="$_GHE_HOST"
          DEPLOY_FETCH_T5="${{ inputs.deploy_fetch_t5 }}"
          DEPLOY_GH_MCP_T5="${{ inputs.deploy_gh_mcp_t5 }}"
          DEPLOY_WEB_T5="${{ inputs.deploy_web_t5 }}"

          # Validate fetch-t5 release
          if [ "$DEPLOY_FETCH_T5" = "true" ]; then
            FETCH_T5_TAG="${{ inputs.fetch_t5_release_tag }}"
            echo "Validating fetch-t5 release ${FETCH_T5_TAG} in ${FETCH_T5_UPSTREAM_REPO}..."
            RELEASE_INFO=$(gh api "repos/${FETCH_T5_UPSTREAM_REPO}/releases/tags/${FETCH_T5_TAG}" --jq '.tag_name' 2>&1) || {
              echo "Error: Release ${FETCH_T5_TAG} not found in ${FETCH_T5_UPSTREAM_REPO}"
              echo "API response: ${RELEASE_INFO}"
              exit 1
            }
            echo "fetch-t5 release validated: ${RELEASE_INFO}"

            FETCH_T5_VERSION=${FETCH_T5_TAG#v}
            FETCH_T5_APP_VERSION=${FETCH_T5_VERSION//./-}
            echo "fetch_t5_release_tag=${FETCH_T5_TAG}" >> "$GITHUB_OUTPUT"
            echo "fetch_t5_version=${FETCH_T5_APP_VERSION}" >> "$GITHUB_OUTPUT"
            echo "fetch_t5_version_dotted=${FETCH_T5_VERSION}" >> "$GITHUB_OUTPUT"
          fi

          # Validate gh-mcp-t5 release
          if [ "$DEPLOY_GH_MCP_T5" = "true" ]; then
            GH_MCP_T5_TAG="${{ inputs.gh_mcp_t5_release_tag }}"
            echo "Validating gh-mcp-t5 release ${GH_MCP_T5_TAG} in ${GH_MCP_T5_UPSTREAM_REPO}..."
            RELEASE_INFO=$(gh api "repos/${GH_MCP_T5_UPSTREAM_REPO}/releases/tags/${GH_MCP_T5_TAG}" --jq '.tag_name' 2>&1) || {
              echo "Error: Release ${GH_MCP_T5_TAG} not found in ${GH_MCP_T5_UPSTREAM_REPO}"
              echo "API response: ${RELEASE_INFO}"
              exit 1
            }
            echo "gh-mcp-t5 release validated: ${RELEASE_INFO}"

            GH_MCP_T5_VERSION=${GH_MCP_T5_TAG#v}
            GH_MCP_T5_APP_VERSION=${GH_MCP_T5_VERSION//./-}
            echo "gh_mcp_t5_release_tag=${GH_MCP_T5_TAG}" >> "$GITHUB_OUTPUT"
            echo "gh_mcp_t5_version=${GH_MCP_T5_APP_VERSION}" >> "$GITHUB_OUTPUT"
            echo "gh_mcp_t5_version_dotted=${GH_MCP_T5_VERSION}" >> "$GITHUB_OUTPUT"
          fi

          # Validate web-t5 release
          if [ "$DEPLOY_WEB_T5" = "true" ]; then
            WEB_T5_TAG="${{ inputs.web_t5_release_tag }}"
            echo "Validating web-t5 release ${WEB_T5_TAG} in ${WEB_T5_UPSTREAM_REPO}..."
            RELEASE_INFO=$(gh api "repos/${WEB_T5_UPSTREAM_REPO}/releases/tags/${WEB_T5_TAG}" --jq '.tag_name' 2>&1) || {
              echo "Error: Release ${WEB_T5_TAG} not found in ${WEB_T5_UPSTREAM_REPO}"
              echo "API response: ${RELEASE_INFO}"
              exit 1
            }
            echo "web-t5 release validated: ${RELEASE_INFO}"

            WEB_T5_VERSION=${WEB_T5_TAG#v}
            WEB_T5_APP_VERSION=${WEB_T5_VERSION//./-}
            echo "web_t5_release_tag=${WEB_T5_TAG}" >> "$GITHUB_OUTPUT"
            echo "web_t5_version=${WEB_T5_APP_VERSION}" >> "$GITHUB_OUTPUT"
            echo "web_t5_version_dotted=${WEB_T5_VERSION}" >> "$GITHUB_OUTPUT"
          fi

          echo "deploy_fetch_t5=${DEPLOY_FETCH_T5}" >> "$GITHUB_OUTPUT"
          echo "deploy_gh_mcp_t5=${DEPLOY_GH_MCP_T5}" >> "$GITHUB_OUTPUT"
          echo "deploy_web_t5=${DEPLOY_WEB_T5}" >> "$GITHUB_OUTPUT"

  # ──────────────────────────────────────────────────────────────
  # Job 2: Deploy apps to Non-Production
  # ──────────────────────────────────────────────────────────────
  deploy-nonprod:
    needs: validate-and-prepare
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install CF CLI
        run: |
          curl -sL "https://packages.cloudfoundry.org/stable?release=linux64-binary&version=${{ env.CF_CLI_VERSION }}&source=github" | tar -zx
          chmod +x cf8

      - name: Authenticate to Nonprod CF
        env:
          CF_API: ${{ secrets.CF_NONPROD_API }}
          CF_USER: ${{ secrets.CF_NONPROD_USERNAME }}
          CF_PASS: ${{ secrets.CF_NONPROD_PASSWORD }}
          CF_ORG: ${{ secrets.CF_NONPROD_ORG }}
          CF_SPACE: ${{ secrets.CF_NONPROD_SPACE }}
        run: |
          ./cf8 api "$CF_API"
          ./cf8 auth "$CF_USER" "$CF_PASS"
          ./cf8 target -o "$CF_ORG" -s "$CF_SPACE"
          echo "Authenticated to Nonprod CF: ${CF_API}"

      - name: Configure GitHub Authentication
        env:
          GHE_TOKEN: ${{ secrets.GHE_TOKEN }}
          GHE_HOST: ${{ secrets.GHE_HOST }}
        run: |
          if [ -n "$GHE_HOST" ]; then
            echo "${GHE_TOKEN}" | gh auth login --hostname "${GHE_HOST}" --with-token
          else
            echo "${GHE_TOKEN}" | gh auth login --with-token
          fi

      - name: Download fetch-t5 release assets
        if: needs.validate-and-prepare.outputs.deploy_fetch_t5 == 'true'
        env:
          _GHE_HOST: ${{ secrets.GHE_HOST }}
          GH_TOKEN: ${{ secrets.GHE_TOKEN }}
          UPSTREAM_REPO: ${{ secrets.FETCH_T5_UPSTREAM_REPO }}
          ARTIFACT_PATTERN: ${{ secrets.FETCH_T5_ARTIFACT_PATTERN }}
          FETCH_T5_MANIFEST: ${{ secrets.FETCH_T5_MANIFEST_PATH }}
        run: |
          [ -n "$_GHE_HOST" ] && export GH_HOST="$_GHE_HOST"
          VERSION_DOTTED="${{ needs.validate-and-prepare.outputs.fetch_t5_version_dotted }}"

          PATTERN=$(echo "${ARTIFACT_PATTERN}" | sed "s/{version}/${VERSION_DOTTED}/g")
          echo "Downloading fetch-t5 artifact matching: ${PATTERN}"

          mkdir -p ./fetch_t5
          gh release download "${{ needs.validate-and-prepare.outputs.fetch_t5_release_tag }}" \
            --repo "${UPSTREAM_REPO}" \
            --pattern "${PATTERN}" \
            --dir ./fetch_t5

          MANIFEST_PATH="${FETCH_T5_MANIFEST:-manifests/fetch_t5/manifest.yml}"
          if [ ! -f "$MANIFEST_PATH" ]; then
            echo "Error: fetch-t5 manifest not found at ${MANIFEST_PATH}"
            exit 1
          fi
          cp "$MANIFEST_PATH" ./fetch_t5/manifest.yml
          echo "fetch-t5 release assets and manifest ready:"
          ls -la ./fetch_t5/

      - name: Deploy fetch-t5 to Nonprod
        if: needs.validate-and-prepare.outputs.deploy_fetch_t5 == 'true'
        env:
          FETCH_T5_NAME: ${{ secrets.FETCH_T5_NAME }}
          VERSION: ${{ needs.validate-and-prepare.outputs.fetch_t5_version }}
          FETCH_T5_CF_ENV_JSON: ${{ secrets.FETCH_T5_CF_ENV_JSON }}
        run: |
          DEPLOY_NAME="${FETCH_T5_NAME}-nonprod-${VERSION}"
          ARTIFACT=$(ls ./fetch_t5/ | grep -v manifest.yml | head -1)
          echo "Artifact found: ${ARTIFACT}"

          if [ -n "$FETCH_T5_CF_ENV_JSON" ]; then
            echo "Pushing ${DEPLOY_NAME} (--no-start, env vars to inject)..."
            ./cf8 push "${DEPLOY_NAME}" \
              -f ./fetch_t5/manifest.yml \
              -p "./fetch_t5/${ARTIFACT}" \
              --no-start

            echo "Setting env vars..."
            echo "${FETCH_T5_CF_ENV_JSON}" | jq -r 'to_entries[] | "\(.key) \(.value)"' | while read -r key value; do
              ./cf8 set-env "${DEPLOY_NAME}" "$key" "$value"
            done

            echo "Starting ${DEPLOY_NAME}..."
            ./cf8 start "${DEPLOY_NAME}"
          else
            echo "Deploying ${DEPLOY_NAME}..."
            ./cf8 push "${DEPLOY_NAME}" \
              -f ./fetch_t5/manifest.yml \
              -p "./fetch_t5/${ARTIFACT}"
          fi

          echo "fetch-t5 deployed to nonprod: ${DEPLOY_NAME}"

      - name: Download and extract gh-mcp-t5 release assets
        if: needs.validate-and-prepare.outputs.deploy_gh_mcp_t5 == 'true'
        env:
          _GHE_HOST: ${{ secrets.GHE_HOST }}
          GH_TOKEN: ${{ secrets.GHE_TOKEN }}
          UPSTREAM_REPO: ${{ secrets.GH_MCP_T5_UPSTREAM_REPO }}
          ARTIFACT_PATTERN: ${{ secrets.GH_MCP_T5_ARTIFACT_PATTERN }}
          GH_MCP_T5_MANIFEST: ${{ secrets.GH_MCP_T5_MANIFEST_PATH }}
        run: |
          [ -n "$_GHE_HOST" ] && export GH_HOST="$_GHE_HOST"
          VERSION_DOTTED="${{ needs.validate-and-prepare.outputs.gh_mcp_t5_version_dotted }}"

          PATTERN=$(echo "${ARTIFACT_PATTERN}" | sed "s/{version}/${VERSION_DOTTED}/g")
          echo "Downloading gh-mcp-t5 artifact matching: ${PATTERN}"

          mkdir -p ./gh_mcp_t5
          gh release download "${{ needs.validate-and-prepare.outputs.gh_mcp_t5_release_tag }}" \
            --repo "${UPSTREAM_REPO}" \
            --pattern "${PATTERN}" \
            --dir ./gh_mcp_t5

          ARCHIVE=$(ls ./gh_mcp_t5/ | head -1)
          echo "Extracting ${ARCHIVE}..."
          mkdir -p ./gh_mcp_t5/extracted
          if [[ "${ARCHIVE}" == *.tar.gz ]] || [[ "${ARCHIVE}" == *.tgz ]]; then
            tar -xzf "./gh_mcp_t5/${ARCHIVE}" -C ./gh_mcp_t5/extracted
          elif [[ "${ARCHIVE}" == *.zip ]]; then
            unzip -o "./gh_mcp_t5/${ARCHIVE}" -d ./gh_mcp_t5/extracted
          else
            echo "Error: Unknown archive format: ${ARCHIVE}"
            exit 1
          fi

          MANIFEST_PATH="${GH_MCP_T5_MANIFEST:-manifests/gh_mcp_t5/manifest.yml}"
          if [ ! -f "$MANIFEST_PATH" ]; then
            echo "Error: gh-mcp-t5 manifest not found at ${MANIFEST_PATH}"
            exit 1
          fi
          cp "$MANIFEST_PATH" ./gh_mcp_t5/extracted/manifest.yml
          echo "gh-mcp-t5 extracted contents:"
          ls -la ./gh_mcp_t5/extracted/

      - name: Deploy gh-mcp-t5 to Nonprod
        if: needs.validate-and-prepare.outputs.deploy_gh_mcp_t5 == 'true'
        env:
          GH_MCP_T5_NAME: ${{ secrets.GH_MCP_T5_NAME }}
          VERSION: ${{ needs.validate-and-prepare.outputs.gh_mcp_t5_version }}
          GH_MCP_T5_CF_ENV_JSON: ${{ secrets.GH_MCP_T5_CF_ENV_JSON }}
        run: |
          DEPLOY_NAME="${GH_MCP_T5_NAME}-nonprod-${VERSION}"
          echo "Deploying ${DEPLOY_NAME} from extracted directory..."

          if [ -n "$GH_MCP_T5_CF_ENV_JSON" ]; then
            ./cf8 push "${DEPLOY_NAME}" \
              -f ./gh_mcp_t5/extracted/manifest.yml \
              -p "./gh_mcp_t5/extracted" \
              --no-start

            echo "Setting env vars..."
            echo "${GH_MCP_T5_CF_ENV_JSON}" | jq -r 'to_entries[] | "\(.key) \(.value)"' | while read -r key value; do
              ./cf8 set-env "${DEPLOY_NAME}" "$key" "$value"
            done

            echo "Starting ${DEPLOY_NAME}..."
            ./cf8 start "${DEPLOY_NAME}"
          else
            ./cf8 push "${DEPLOY_NAME}" \
              -f ./gh_mcp_t5/extracted/manifest.yml \
              -p "./gh_mcp_t5/extracted"
          fi

          echo "gh-mcp-t5 deployed to nonprod: ${DEPLOY_NAME}"

      - name: Download web-t5 release assets
        if: needs.validate-and-prepare.outputs.deploy_web_t5 == 'true'
        env:
          _GHE_HOST: ${{ secrets.GHE_HOST }}
          GH_TOKEN: ${{ secrets.GHE_TOKEN }}
          UPSTREAM_REPO: ${{ secrets.WEB_T5_UPSTREAM_REPO }}
          ARTIFACT_PATTERN: ${{ secrets.WEB_T5_ARTIFACT_PATTERN }}
          WEB_T5_MANIFEST: ${{ secrets.WEB_T5_MANIFEST_PATH }}
        run: |
          [ -n "$_GHE_HOST" ] && export GH_HOST="$_GHE_HOST"
          VERSION_DOTTED="${{ needs.validate-and-prepare.outputs.web_t5_version_dotted }}"

          PATTERN=$(echo "${ARTIFACT_PATTERN}" | sed "s/{version}/${VERSION_DOTTED}/g")
          echo "Downloading web-t5 artifact matching: ${PATTERN}"

          mkdir -p ./web_t5
          gh release download "${{ needs.validate-and-prepare.outputs.web_t5_release_tag }}" \
            --repo "${UPSTREAM_REPO}" \
            --pattern "${PATTERN}" \
            --dir ./web_t5

          MANIFEST_PATH="${WEB_T5_MANIFEST:-manifests/web_t5/manifest.yml}"
          if [ ! -f "$MANIFEST_PATH" ]; then
            echo "Error: web-t5 manifest not found at ${MANIFEST_PATH}"
            exit 1
          fi
          cp "$MANIFEST_PATH" ./web_t5/manifest.yml
          echo "web-t5 release assets and manifest ready:"
          ls -la ./web_t5/

      - name: Deploy web-t5 to Nonprod
        if: needs.validate-and-prepare.outputs.deploy_web_t5 == 'true'
        env:
          WEB_T5_NAME: ${{ secrets.WEB_T5_NAME }}
          VERSION: ${{ needs.validate-and-prepare.outputs.web_t5_version }}
          WEB_T5_CF_ENV_JSON: ${{ secrets.WEB_T5_CF_ENV_JSON }}
        run: |
          DEPLOY_NAME="${WEB_T5_NAME}-nonprod-${VERSION}"
          ARTIFACT=$(ls ./web_t5/ | grep -v manifest.yml | head -1)
          echo "Artifact found: ${ARTIFACT}"

          if [ -n "$WEB_T5_CF_ENV_JSON" ]; then
            echo "Pushing ${DEPLOY_NAME} (--no-start, env vars to inject)..."
            ./cf8 push "${DEPLOY_NAME}" \
              -f ./web_t5/manifest.yml \
              -p "./web_t5/${ARTIFACT}" \
              --no-start

            echo "Setting env vars..."
            echo "${WEB_T5_CF_ENV_JSON}" | jq -r 'to_entries[] | "\(.key) \(.value)"' | while read -r key value; do
              ./cf8 set-env "${DEPLOY_NAME}" "$key" "$value"
            done

            echo "Starting ${DEPLOY_NAME}..."
            ./cf8 start "${DEPLOY_NAME}"
          else
            echo "Deploying ${DEPLOY_NAME}..."
            ./cf8 push "${DEPLOY_NAME}" \
              -f ./web_t5/manifest.yml \
              -p "./web_t5/${ARTIFACT}"
          fi

          echo "web-t5 deployed to nonprod: ${DEPLOY_NAME}"

      - name: Configure Authentication for git push
        env:
          GHE_TOKEN: ${{ secrets.GHE_TOKEN }}
          GHE_HOST: ${{ secrets.GHE_HOST }}
        run: |
          if [ -n "$GHE_HOST" ]; then
            git remote set-url origin "https://x-access-token:${GHE_TOKEN}@${GHE_HOST}/${{ github.repository }}.git"
          else
            git remote set-url origin "https://x-access-token:${GHE_TOKEN}@github.com/${{ github.repository }}.git"
          fi

      - name: Record nonprod deployed versions
        env:
          FETCH_T5_NAME: ${{ secrets.FETCH_T5_NAME }}
          GH_MCP_T5_NAME: ${{ secrets.GH_MCP_T5_NAME }}
          WEB_T5_NAME: ${{ secrets.WEB_T5_NAME }}
        run: |
          DEPLOY_FETCH_T5="${{ needs.validate-and-prepare.outputs.deploy_fetch_t5 }}"
          DEPLOY_GH_MCP_T5="${{ needs.validate-and-prepare.outputs.deploy_gh_mcp_t5 }}"
          DEPLOY_WEB_T5="${{ needs.validate-and-prepare.outputs.deploy_web_t5 }}"

          CHANGED=false

          if [ "$DEPLOY_FETCH_T5" = "true" ]; then
            echo "${{ needs.validate-and-prepare.outputs.fetch_t5_release_tag }}" > ".last-deployed-${FETCH_T5_NAME}-nonprod"
            git add ".last-deployed-${FETCH_T5_NAME}-nonprod"
            CHANGED=true
          fi

          if [ "$DEPLOY_GH_MCP_T5" = "true" ]; then
            echo "${{ needs.validate-and-prepare.outputs.gh_mcp_t5_release_tag }}" > ".last-deployed-${GH_MCP_T5_NAME}-nonprod"
            git add ".last-deployed-${GH_MCP_T5_NAME}-nonprod"
            CHANGED=true
          fi

          if [ "$DEPLOY_WEB_T5" = "true" ]; then
            echo "${{ needs.validate-and-prepare.outputs.web_t5_release_tag }}" > ".last-deployed-${WEB_T5_NAME}-nonprod"
            git add ".last-deployed-${WEB_T5_NAME}-nonprod"
            CHANGED=true
          fi

          if [ "$CHANGED" = "true" ]; then
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"

            MSG="Record nonprod deployment:"
            if [ "$DEPLOY_FETCH_T5" = "true" ]; then
              MSG="${MSG} ${FETCH_T5_NAME}=${{ needs.validate-and-prepare.outputs.fetch_t5_release_tag }}"
            fi
            if [ "$DEPLOY_GH_MCP_T5" = "true" ]; then
              MSG="${MSG} ${GH_MCP_T5_NAME}=${{ needs.validate-and-prepare.outputs.gh_mcp_t5_release_tag }}"
            fi
            if [ "$DEPLOY_WEB_T5" = "true" ]; then
              MSG="${MSG} ${WEB_T5_NAME}=${{ needs.validate-and-prepare.outputs.web_t5_release_tag }}"
            fi

            git diff --cached --quiet || git commit -m "${MSG}"
            git push
          fi

  # ──────────────────────────────────────────────────────────────
  # Job 3: Send approval notification
  #
  # GitHub automatically emails environment reviewers when the
  # deploy-prod job reaches the 'production' environment gate.
  # This job creates an additional deployment notification for
  # broader visibility (repo watchers, team channels, etc).
  # ──────────────────────────────────────────────────────────────
  notify-approval-required:
    needs: [validate-and-prepare, deploy-nonprod]
    runs-on: ubuntu-latest
    steps:
      - name: Configure GitHub Authentication
        env:
          GHE_TOKEN: ${{ secrets.GHE_TOKEN }}
          GHE_HOST: ${{ secrets.GHE_HOST }}
        run: |
          if [ -n "$GHE_HOST" ]; then
            echo "${GHE_TOKEN}" | gh auth login --hostname "${GHE_HOST}" --with-token
          else
            echo "${GHE_TOKEN}" | gh auth login --with-token
          fi

      - name: Send deployment approval notification
        env:
          _GHE_HOST: ${{ secrets.GHE_HOST }}
          GH_TOKEN: ${{ secrets.GHE_TOKEN }}
          APPROVAL_REVIEWERS: ${{ secrets.APPROVAL_REVIEWERS }}
          FETCH_T5_NAME: ${{ secrets.FETCH_T5_NAME }}
          GH_MCP_T5_NAME: ${{ secrets.GH_MCP_T5_NAME }}
          WEB_T5_NAME: ${{ secrets.WEB_T5_NAME }}
        run: |
          [ -n "$_GHE_HOST" ] && export GH_HOST="$_GHE_HOST"
          RUN_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

          DEPLOY_FETCH_T5="${{ needs.validate-and-prepare.outputs.deploy_fetch_t5 }}"

          DEPLOY_GH_MCP_T5="${{ needs.validate-and-prepare.outputs.deploy_gh_mcp_t5 }}"

          DEPLOY_WEB_T5="${{ needs.validate-and-prepare.outputs.deploy_web_t5 }}"

          # Build description of what's being deployed
          APPS_LIST=""
          if [ "$DEPLOY_FETCH_T5" = "true" ]; then
            FETCH_T5_TAG="${{ needs.validate-and-prepare.outputs.fetch_t5_release_tag }}"
            if [ -n "$APPS_LIST" ]; then APPS_LIST="${APPS_LIST}, "; fi
            APPS_LIST="${APPS_LIST}${FETCH_T5_NAME} (${FETCH_T5_TAG})"
          fi
          if [ "$DEPLOY_GH_MCP_T5" = "true" ]; then
            GH_MCP_T5_TAG="${{ needs.validate-and-prepare.outputs.gh_mcp_t5_release_tag }}"
            if [ -n "$APPS_LIST" ]; then APPS_LIST="${APPS_LIST}, "; fi
            APPS_LIST="${APPS_LIST}${GH_MCP_T5_NAME} (${GH_MCP_T5_TAG})"
          fi
          if [ "$DEPLOY_WEB_T5" = "true" ]; then
            WEB_T5_TAG="${{ needs.validate-and-prepare.outputs.web_t5_release_tag }}"
            if [ -n "$APPS_LIST" ]; then APPS_LIST="${APPS_LIST}, "; fi
            APPS_LIST="${APPS_LIST}${WEB_T5_NAME} (${WEB_T5_TAG})"
          fi

          # Build reviewer mentions for notification
          REVIEWERS_MENTION=""
          if [ -n "$APPROVAL_REVIEWERS" ]; then
            IFS=',' read -ra REVIEWERS <<< "$APPROVAL_REVIEWERS"
            for reviewer in "${REVIEWERS[@]}"; do
              reviewer=$(echo "$reviewer" | xargs)
              REVIEWERS_MENTION="${REVIEWERS_MENTION}@${reviewer} "
            done
          fi

          DESCRIPTION="Production deployment approval required. Apps: ${APPS_LIST}. Review: ${RUN_URL} ${REVIEWERS_MENTION}"

          echo "=========================================="
          echo "PRODUCTION DEPLOYMENT APPROVAL REQUIRED"
          echo "=========================================="
          echo "Apps:       ${APPS_LIST}"
          echo "Approve at: ${RUN_URL}"
          echo "Reviewers:  ${APPROVAL_REVIEWERS}"
          echo "=========================================="

          # Create a deployment event via GitHub API to trigger email notifications
          gh api "repos/${{ github.repository }}/deployments" \
            --input - <<DEPEOF || echo "::warning::Could not create deployment notification (non-blocking)"
          {
            "ref": "${{ github.sha }}",
            "environment": "production-pending",
            "description": "${DESCRIPTION}",
            "auto_merge": false,
            "required_contexts": []
          }
          DEPEOF

  # ──────────────────────────────────────────────────────────────
  # Job 4: Deploy apps to Production
  #
  # Gated by the 'production' environment which requires manual
  # approval. GitHub sends email to configured reviewers asking
  # them to approve or reject the deployment.
  #
  # To configure the approval gate:
  #   1. Go to Settings > Environments > New environment > "production"
  #   2. Enable "Required reviewers"
  #   3. Add the users/teams who should approve prod deployments
  #   4. GitHub will email those reviewers when this job is reached
  # ──────────────────────────────────────────────────────────────
  deploy-prod:
    needs: [validate-and-prepare, deploy-nonprod]
    runs-on: ubuntu-latest
    environment: production
    steps:
      - uses: actions/checkout@v4

      - name: Install CF CLI
        run: |
          curl -sL "https://packages.cloudfoundry.org/stable?release=linux64-binary&version=${{ env.CF_CLI_VERSION }}&source=github" | tar -zx
          chmod +x cf8

      - name: Authenticate to Prod CF
        env:
          CF_API: ${{ secrets.CF_PROD_API }}
          CF_USER: ${{ secrets.CF_PROD_USERNAME }}
          CF_PASS: ${{ secrets.CF_PROD_PASSWORD }}
          CF_ORG: ${{ secrets.CF_PROD_ORG }}
          CF_SPACE: ${{ secrets.CF_PROD_SPACE }}
        run: |
          ./cf8 api "$CF_API"
          ./cf8 auth "$CF_USER" "$CF_PASS"
          ./cf8 target -o "$CF_ORG" -s "$CF_SPACE"
          echo "Authenticated to Prod CF: ${CF_API}"

      - name: Configure GitHub Authentication
        env:
          GHE_TOKEN: ${{ secrets.GHE_TOKEN }}
          GHE_HOST: ${{ secrets.GHE_HOST }}
        run: |
          if [ -n "$GHE_HOST" ]; then
            echo "${GHE_TOKEN}" | gh auth login --hostname "${GHE_HOST}" --with-token
          else
            echo "${GHE_TOKEN}" | gh auth login --with-token
          fi

      - name: Download fetch-t5 release assets
        if: needs.validate-and-prepare.outputs.deploy_fetch_t5 == 'true'
        env:
          _GHE_HOST: ${{ secrets.GHE_HOST }}
          GH_TOKEN: ${{ secrets.GHE_TOKEN }}
          UPSTREAM_REPO: ${{ secrets.FETCH_T5_UPSTREAM_REPO }}
          ARTIFACT_PATTERN: ${{ secrets.FETCH_T5_ARTIFACT_PATTERN }}
          FETCH_T5_MANIFEST: ${{ secrets.FETCH_T5_MANIFEST_PATH }}
        run: |
          [ -n "$_GHE_HOST" ] && export GH_HOST="$_GHE_HOST"
          VERSION_DOTTED="${{ needs.validate-and-prepare.outputs.fetch_t5_version_dotted }}"

          PATTERN=$(echo "${ARTIFACT_PATTERN}" | sed "s/{version}/${VERSION_DOTTED}/g")
          echo "Downloading fetch-t5 artifact matching: ${PATTERN}"

          mkdir -p ./fetch_t5
          gh release download "${{ needs.validate-and-prepare.outputs.fetch_t5_release_tag }}" \
            --repo "${UPSTREAM_REPO}" \
            --pattern "${PATTERN}" \
            --dir ./fetch_t5

          MANIFEST_PATH="${FETCH_T5_MANIFEST:-manifests/fetch_t5/manifest.yml}"
          if [ ! -f "$MANIFEST_PATH" ]; then
            echo "Error: fetch-t5 manifest not found at ${MANIFEST_PATH}"
            exit 1
          fi
          cp "$MANIFEST_PATH" ./fetch_t5/manifest.yml
          echo "fetch-t5 release assets and manifest ready:"
          ls -la ./fetch_t5/

      - name: Deploy fetch-t5 to Prod
        if: needs.validate-and-prepare.outputs.deploy_fetch_t5 == 'true'
        env:
          FETCH_T5_NAME: ${{ secrets.FETCH_T5_NAME }}
          VERSION: ${{ needs.validate-and-prepare.outputs.fetch_t5_version }}
          FETCH_T5_CF_ENV_JSON: ${{ secrets.FETCH_T5_CF_ENV_JSON }}
        run: |
          DEPLOY_NAME="${FETCH_T5_NAME}-prod-${VERSION}"
          ARTIFACT=$(ls ./fetch_t5/ | grep -v manifest.yml | head -1)
          echo "Artifact found: ${ARTIFACT}"

          if [ -n "$FETCH_T5_CF_ENV_JSON" ]; then
            echo "Pushing ${DEPLOY_NAME} (--no-start, env vars to inject)..."
            ./cf8 push "${DEPLOY_NAME}" \
              -f ./fetch_t5/manifest.yml \
              -p "./fetch_t5/${ARTIFACT}" \
              --no-start

            echo "Setting env vars..."
            echo "${FETCH_T5_CF_ENV_JSON}" | jq -r 'to_entries[] | "\(.key) \(.value)"' | while read -r key value; do
              ./cf8 set-env "${DEPLOY_NAME}" "$key" "$value"
            done

            echo "Starting ${DEPLOY_NAME}..."
            ./cf8 start "${DEPLOY_NAME}"
          else
            echo "Deploying ${DEPLOY_NAME}..."
            ./cf8 push "${DEPLOY_NAME}" \
              -f ./fetch_t5/manifest.yml \
              -p "./fetch_t5/${ARTIFACT}"
          fi

          echo "fetch-t5 deployed to prod: ${DEPLOY_NAME}"

      - name: Download and extract gh-mcp-t5 release assets
        if: needs.validate-and-prepare.outputs.deploy_gh_mcp_t5 == 'true'
        env:
          _GHE_HOST: ${{ secrets.GHE_HOST }}
          GH_TOKEN: ${{ secrets.GHE_TOKEN }}
          UPSTREAM_REPO: ${{ secrets.GH_MCP_T5_UPSTREAM_REPO }}
          ARTIFACT_PATTERN: ${{ secrets.GH_MCP_T5_ARTIFACT_PATTERN }}
          GH_MCP_T5_MANIFEST: ${{ secrets.GH_MCP_T5_MANIFEST_PATH }}
        run: |
          [ -n "$_GHE_HOST" ] && export GH_HOST="$_GHE_HOST"
          VERSION_DOTTED="${{ needs.validate-and-prepare.outputs.gh_mcp_t5_version_dotted }}"

          PATTERN=$(echo "${ARTIFACT_PATTERN}" | sed "s/{version}/${VERSION_DOTTED}/g")
          echo "Downloading gh-mcp-t5 artifact matching: ${PATTERN}"

          mkdir -p ./gh_mcp_t5
          gh release download "${{ needs.validate-and-prepare.outputs.gh_mcp_t5_release_tag }}" \
            --repo "${UPSTREAM_REPO}" \
            --pattern "${PATTERN}" \
            --dir ./gh_mcp_t5

          ARCHIVE=$(ls ./gh_mcp_t5/ | head -1)
          echo "Extracting ${ARCHIVE}..."
          mkdir -p ./gh_mcp_t5/extracted
          if [[ "${ARCHIVE}" == *.tar.gz ]] || [[ "${ARCHIVE}" == *.tgz ]]; then
            tar -xzf "./gh_mcp_t5/${ARCHIVE}" -C ./gh_mcp_t5/extracted
          elif [[ "${ARCHIVE}" == *.zip ]]; then
            unzip -o "./gh_mcp_t5/${ARCHIVE}" -d ./gh_mcp_t5/extracted
          else
            echo "Error: Unknown archive format: ${ARCHIVE}"
            exit 1
          fi

          MANIFEST_PATH="${GH_MCP_T5_MANIFEST:-manifests/gh_mcp_t5/manifest.yml}"
          if [ ! -f "$MANIFEST_PATH" ]; then
            echo "Error: gh-mcp-t5 manifest not found at ${MANIFEST_PATH}"
            exit 1
          fi
          cp "$MANIFEST_PATH" ./gh_mcp_t5/extracted/manifest.yml
          echo "gh-mcp-t5 extracted contents:"
          ls -la ./gh_mcp_t5/extracted/

      - name: Deploy gh-mcp-t5 to Prod
        if: needs.validate-and-prepare.outputs.deploy_gh_mcp_t5 == 'true'
        env:
          GH_MCP_T5_NAME: ${{ secrets.GH_MCP_T5_NAME }}
          VERSION: ${{ needs.validate-and-prepare.outputs.gh_mcp_t5_version }}
          GH_MCP_T5_CF_ENV_JSON: ${{ secrets.GH_MCP_T5_CF_ENV_JSON }}
        run: |
          DEPLOY_NAME="${GH_MCP_T5_NAME}-prod-${VERSION}"
          echo "Deploying ${DEPLOY_NAME} from extracted directory..."

          if [ -n "$GH_MCP_T5_CF_ENV_JSON" ]; then
            ./cf8 push "${DEPLOY_NAME}" \
              -f ./gh_mcp_t5/extracted/manifest.yml \
              -p "./gh_mcp_t5/extracted" \
              --no-start

            echo "Setting env vars..."
            echo "${GH_MCP_T5_CF_ENV_JSON}" | jq -r 'to_entries[] | "\(.key) \(.value)"' | while read -r key value; do
              ./cf8 set-env "${DEPLOY_NAME}" "$key" "$value"
            done

            echo "Starting ${DEPLOY_NAME}..."
            ./cf8 start "${DEPLOY_NAME}"
          else
            ./cf8 push "${DEPLOY_NAME}" \
              -f ./gh_mcp_t5/extracted/manifest.yml \
              -p "./gh_mcp_t5/extracted"
          fi

          echo "gh-mcp-t5 deployed to prod: ${DEPLOY_NAME}"

      - name: Download web-t5 release assets
        if: needs.validate-and-prepare.outputs.deploy_web_t5 == 'true'
        env:
          _GHE_HOST: ${{ secrets.GHE_HOST }}
          GH_TOKEN: ${{ secrets.GHE_TOKEN }}
          UPSTREAM_REPO: ${{ secrets.WEB_T5_UPSTREAM_REPO }}
          ARTIFACT_PATTERN: ${{ secrets.WEB_T5_ARTIFACT_PATTERN }}
          WEB_T5_MANIFEST: ${{ secrets.WEB_T5_MANIFEST_PATH }}
        run: |
          [ -n "$_GHE_HOST" ] && export GH_HOST="$_GHE_HOST"
          VERSION_DOTTED="${{ needs.validate-and-prepare.outputs.web_t5_version_dotted }}"

          PATTERN=$(echo "${ARTIFACT_PATTERN}" | sed "s/{version}/${VERSION_DOTTED}/g")
          echo "Downloading web-t5 artifact matching: ${PATTERN}"

          mkdir -p ./web_t5
          gh release download "${{ needs.validate-and-prepare.outputs.web_t5_release_tag }}" \
            --repo "${UPSTREAM_REPO}" \
            --pattern "${PATTERN}" \
            --dir ./web_t5

          MANIFEST_PATH="${WEB_T5_MANIFEST:-manifests/web_t5/manifest.yml}"
          if [ ! -f "$MANIFEST_PATH" ]; then
            echo "Error: web-t5 manifest not found at ${MANIFEST_PATH}"
            exit 1
          fi
          cp "$MANIFEST_PATH" ./web_t5/manifest.yml
          echo "web-t5 release assets and manifest ready:"
          ls -la ./web_t5/

      - name: Deploy web-t5 to Prod
        if: needs.validate-and-prepare.outputs.deploy_web_t5 == 'true'
        env:
          WEB_T5_NAME: ${{ secrets.WEB_T5_NAME }}
          VERSION: ${{ needs.validate-and-prepare.outputs.web_t5_version }}
          WEB_T5_CF_ENV_JSON: ${{ secrets.WEB_T5_CF_ENV_JSON }}
        run: |
          DEPLOY_NAME="${WEB_T5_NAME}-prod-${VERSION}"
          ARTIFACT=$(ls ./web_t5/ | grep -v manifest.yml | head -1)
          echo "Artifact found: ${ARTIFACT}"

          if [ -n "$WEB_T5_CF_ENV_JSON" ]; then
            echo "Pushing ${DEPLOY_NAME} (--no-start, env vars to inject)..."
            ./cf8 push "${DEPLOY_NAME}" \
              -f ./web_t5/manifest.yml \
              -p "./web_t5/${ARTIFACT}" \
              --no-start

            echo "Setting env vars..."
            echo "${WEB_T5_CF_ENV_JSON}" | jq -r 'to_entries[] | "\(.key) \(.value)"' | while read -r key value; do
              ./cf8 set-env "${DEPLOY_NAME}" "$key" "$value"
            done

            echo "Starting ${DEPLOY_NAME}..."
            ./cf8 start "${DEPLOY_NAME}"
          else
            echo "Deploying ${DEPLOY_NAME}..."
            ./cf8 push "${DEPLOY_NAME}" \
              -f ./web_t5/manifest.yml \
              -p "./web_t5/${ARTIFACT}"
          fi

          echo "web-t5 deployed to prod: ${DEPLOY_NAME}"

      - name: Configure Authentication for git push
        env:
          GHE_TOKEN: ${{ secrets.GHE_TOKEN }}
          GHE_HOST: ${{ secrets.GHE_HOST }}
        run: |
          if [ -n "$GHE_HOST" ]; then
            git remote set-url origin "https://x-access-token:${GHE_TOKEN}@${GHE_HOST}/${{ github.repository }}.git"
          else
            git remote set-url origin "https://x-access-token:${GHE_TOKEN}@github.com/${{ github.repository }}.git"
          fi

      - name: Record prod deployed versions
        env:
          FETCH_T5_NAME: ${{ secrets.FETCH_T5_NAME }}
          GH_MCP_T5_NAME: ${{ secrets.GH_MCP_T5_NAME }}
          WEB_T5_NAME: ${{ secrets.WEB_T5_NAME }}
        run: |
          DEPLOY_FETCH_T5="${{ needs.validate-and-prepare.outputs.deploy_fetch_t5 }}"
          DEPLOY_GH_MCP_T5="${{ needs.validate-and-prepare.outputs.deploy_gh_mcp_t5 }}"
          DEPLOY_WEB_T5="${{ needs.validate-and-prepare.outputs.deploy_web_t5 }}"

          CHANGED=false

          git pull --rebase

          if [ "$DEPLOY_FETCH_T5" = "true" ]; then
            echo "${{ needs.validate-and-prepare.outputs.fetch_t5_release_tag }}" > ".last-deployed-${FETCH_T5_NAME}-prod"
            git add ".last-deployed-${FETCH_T5_NAME}-prod"
            CHANGED=true
          fi

          if [ "$DEPLOY_GH_MCP_T5" = "true" ]; then
            echo "${{ needs.validate-and-prepare.outputs.gh_mcp_t5_release_tag }}" > ".last-deployed-${GH_MCP_T5_NAME}-prod"
            git add ".last-deployed-${GH_MCP_T5_NAME}-prod"
            CHANGED=true
          fi

          if [ "$DEPLOY_WEB_T5" = "true" ]; then
            echo "${{ needs.validate-and-prepare.outputs.web_t5_release_tag }}" > ".last-deployed-${WEB_T5_NAME}-prod"
            git add ".last-deployed-${WEB_T5_NAME}-prod"
            CHANGED=true
          fi

          if [ "$CHANGED" = "true" ]; then
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"

            MSG="Record prod deployment:"
            if [ "$DEPLOY_FETCH_T5" = "true" ]; then
              MSG="${MSG} ${FETCH_T5_NAME}=${{ needs.validate-and-prepare.outputs.fetch_t5_release_tag }}"
            fi
            if [ "$DEPLOY_GH_MCP_T5" = "true" ]; then
              MSG="${MSG} ${GH_MCP_T5_NAME}=${{ needs.validate-and-prepare.outputs.gh_mcp_t5_release_tag }}"
            fi
            if [ "$DEPLOY_WEB_T5" = "true" ]; then
              MSG="${MSG} ${WEB_T5_NAME}=${{ needs.validate-and-prepare.outputs.web_t5_release_tag }}"
            fi

            git diff --cached --quiet || git commit -m "${MSG}"
            git push
          fi
